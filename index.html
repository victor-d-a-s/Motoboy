<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Drop Driver</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <style>
        /* --- CORE --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #111827; color: #e5e7eb; overflow: hidden; width: 100vw; height: 100vh; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* GERENCIADOR DE ESTADOS (CRÍTICO) */
        .app-state { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow-y: auto; overflow-x: hidden; }
        .app-state.active { display: block; }
        
        /* CLASSES UTILITÁRIAS */
        .hidden-force { display: none !important; }
        
        /* --- ESTILO 99 DRIVER --- */
        
        /* Fundo de Mapa Simulado */
        .map-bg {
            position: fixed; inset: 0; z-index: 0;
            background-color: #151f2e;
            background-image: 
                radial-gradient(#1f2937 15%, transparent 16%),
                radial-gradient(#1f2937 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.4;
        }

        /* Botão GO (Iniciar) */
        .btn-go-container {
            position: fixed; bottom: 100px; left: 0; right: 0;
            display: flex; justify-content: center; z-index: 20;
            pointer-events: none; /* Permite clicar no mapa ao redor */
        }
        .btn-go {
            pointer-events: auto;
            width: 80px; height: 80px; border-radius: 50%;
            background: #10B981; border: 4px solid #065F46;
            color: white; font-size: 14px; font-weight: 900;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            transition: 0.3s; cursor: pointer; text-transform: uppercase;
        }
        .btn-go:active { transform: scale(0.95); }
        .btn-go.offline { background: #EF4444; border-color: #7F1D1D; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }

        /* Header Flutuante */
        .floating-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            padding: 15px; display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(to bottom, rgba(17,24,39,0.9) 0%, transparent 100%);
        }
        
        /* Cards e Painéis */
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1F2937; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px 20px calc(20px + env(safe-area-inset-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 60;
            transform: translateY(0); transition: 0.3s;
        }
        
        /* Inputs & Buttons Gerais */
        .input-dark { background: #374151; border: 1px solid #4B5563; color: white; padding: 14px; border-radius: 12px; width: 100%; outline: none; }
        .btn-primary { background: #FBBF24; color: #111827; font-weight: 800; padding: 14px; border-radius: 12px; width: 100%; text-transform: uppercase; }
        
        /* Menu Lateral */
        #side-menu { position: fixed; top: 0; left: -100%; width: 280px; height: 100%; background: #111827; z-index: 200; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.5); border-right: 1px solid #374151; }
        #side-menu.open { left: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 199; opacity: 0; visibility: hidden; transition: 0.3s; }
        .menu-overlay.open { opacity: 1; visibility: visible; }
        
        /* Modais */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 20px; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1F2937; border-top: 1px solid #374151; display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9CA3AF; font-size: 10px; transition: 0.2s; }
        .nav-item.active { color: #FBBF24; font-weight: bold; transform: translateY(-2px); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* Toast */
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 500; display: flex; flex-direction: column; gap: 10px; width: 90%; pointer-events: none; }
        .toast { background: #374151; color: white; padding: 12px 20px; border-radius: 50px; font-weight: 600; font-size: 13px; opacity: 0; transform: translateY(-20px); transition: 0.3s; pointer-events: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center; border: 1px solid #4B5563; }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <audio id="audio-alert" preload="auto"></audio>

    <div id="state-loading" class="app-state active bg-gray-900 flex flex-col items-center justify-center z-[1000]">
        <div class="mb-6 text-yellow-500 text-6xl animate-bounce"><i class="fas fa-motorcycle"></i></div>
        <div class="w-8 h-8 border-4 border-gray-700 border-t-yellow-500 rounded-full animate-spin"></div>
        <p class="text-gray-500 text-xs mt-4 font-bold tracking-widest uppercase">Carregando...</p>
    </div>

    <div id="state-guest" class="app-state bg-gray-900">
        <div id="screen-login" class="h-full flex flex-col justify-center p-8">
            <div class="mb-10 text-center">
                <div class="inline-flex p-5 rounded-full bg-yellow-500/10 text-yellow-500 mb-4 border border-yellow-500/20"><i class="fas fa-bolt text-4xl"></i></div>
                <h1 class="text-3xl font-bold text-white">Drop Driver</h1>
                <p class="text-gray-500 text-sm">App do Parceiro</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="log-email" class="input-dark" placeholder="E-mail">
                <input type="password" id="log-senha" class="input-dark" placeholder="Senha">
                <button onclick="fazerLogin()" id="btn-login" class="btn-primary shadow-lg">ENTRAR</button>
                <p onclick="toggleGuestScreen('cadastro')" class="text-gray-500 text-xs mt-4 text-center p-4 cursor-pointer">Não tem conta? <span class="text-yellow-500 font-bold">Cadastre-se</span></p>
            </div>
        </div>

        <div id="screen-cadastro" class="h-full p-6 pt-10 hidden-force overflow-y-auto">
            <div class="flex items-center mb-6"><button onclick="toggleGuestScreen('login')" class="text-gray-400 p-2"><i class="fas fa-arrow-left text-xl"></i></button><h2 class="text-xl font-bold text-white ml-2">Criar Conta</h2></div>
            <div class="space-y-4 pb-10">
                <p class="text-yellow-500 text-xs font-bold uppercase">Pessoal</p>
                <input type="text" id="cad-nome" class="input-dark" placeholder="Nome Completo">
                <input type="tel" id="cad-cpf" class="input-dark" placeholder="CPF">
                <div class="flex gap-2"><input type="date" id="cad-nasc" class="input-dark w-2/3"><input type="text" id="cad-idade" class="input-dark w-1/3 text-center" placeholder="Idade" readonly></div>
                <input type="tel" id="cad-zap" class="input-dark" placeholder="WhatsApp">
                
                <p class="text-yellow-500 text-xs font-bold uppercase mt-2">Acesso</p>
                <input type="email" id="cad-email" class="input-dark" placeholder="E-mail">
                <input type="password" id="cad-senha" class="input-dark" placeholder="Senha">
                
                <button onclick="enviarCadastro()" id="btn-cadastrar" class="btn-primary mt-4">ENVIAR</button>
            </div>
        </div>
    </div>

    <div id="state-pending" class="app-state bg-gray-900 flex flex-col justify-center items-center p-8 text-center">
        <div class="w-24 h-24 bg-yellow-500/10 rounded-full flex items-center justify-center mb-6 animate-pulse text-yellow-500 border border-yellow-500/30"><i class="fas fa-clock text-5xl"></i></div>
        <h2 class="text-2xl font-bold text-white mb-2">Em Análise</h2>
        <p class="text-gray-400 text-sm mb-8 leading-relaxed">Seu cadastro foi enviado. Aguarde a aprovação.</p>
        <button onclick="logout()" class="text-red-400 text-sm font-bold border border-red-400/30 px-6 py-2 rounded-full">SAIR DA CONTA</button>
    </div>

    <div id="state-app" class="app-state">
        
        <div class="floating-header">
            <button onclick="toggleMenu()" class="w-10 h-10 bg-gray-800 rounded-full text-white shadow flex items-center justify-center border border-gray-700"><i class="fas fa-bars"></i></button>
            <div class="bg-gray-800 px-4 py-2 rounded-full border border-gray-700 shadow flex items-center gap-2 cursor-pointer" onclick="toggleSaldo()">
                <span class="text-[10px] text-gray-400 uppercase font-bold">SALDO</span>
                <span id="header-saldo" class="text-sm font-bold text-green-400">R$ ****</span>
                <i class="fas fa-eye-slash text-xs text-gray-500 ml-1" id="eye-icon"></i>
            </div>
        </div>

        <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()"></div>
        <div id="side-menu">
            <div class="p-6 bg-gray-800 border-b border-gray-700 text-center pt-10">
                <div class="relative w-20 h-20 mx-auto mb-3">
                    <img id="menu-foto" src="https://ui-avatars.com/api/?name=User" class="w-full h-full rounded-full object-cover border-2 border-yellow-500">
                    <label for="upload-input" class="absolute bottom-0 right-0 bg-gray-700 text-white w-6 h-6 rounded-full flex items-center justify-center cursor-pointer border border-gray-600"><i class="fas fa-camera text-[10px]"></i></label>
                    <input type="file" id="upload-input" hidden accept="image/*" onchange="uploadFoto()">
                </div>
                <h3 id="menu-nome" class="text-white font-bold text-lg leading-tight">...</h3>
                <p id="menu-id" class="text-xs text-gray-500 font-mono mt-1">ID: ...</p>
            </div>
            <div class="py-2">
                <div class="menu-item" onclick="navegar('radar')"><i class="fas fa-map-marked-alt"></i> Início</div>
                <div class="menu-item" onclick="navegar('perfil')"><i class="fas fa-user"></i> Perfil</div>
                <div class="menu-item text-red-400 mt-4" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</div>
            </div>
        </div>

        <div class="map-bg"></div> <div id="view-radar" class="w-full h-full pt-20 pb-32 relative">
            <div id="radar-status" class="flex flex-col items-center justify-center h-1/2 opacity-70">
                <i class="fas fa-power-off text-4xl text-gray-600 mb-2"></i>
                <p class="text-lg font-bold text-gray-400">Você está Offline</p>
            </div>
            <div id="radar-list" class="px-4 space-y-3 pb-24 hidden-force overflow-y-auto h-full"></div>
            
            <div class="btn-go-container">
                <button id="btn-go" class="btn-go" onclick="toggleOnline()">INICIAR</button>
            </div>
        </div>

        <div id="view-perfil" class="w-full h-full pt-20 px-4 pb-24 hidden-force overflow-y-auto bg-gray-900 z-20 absolute top-0">
            <h2 class="text-xl font-bold text-white mb-4">Perfil</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openModal('pass')" class="bg-gray-800 p-3 rounded-xl border border-gray-700 text-xs font-bold text-gray-300"><i class="fas fa-lock block text-lg mb-1"></i> SENHA</button>
                    <button onclick="openModal('pin')" class="bg-gray-800 p-3 rounded-xl border border-gray-700 text-xs font-bold text-gray-300"><i class="fas fa-key block text-lg mb-1"></i> PIN</button>
                </div>
                <div class="dark-card p-4 space-y-3">
                    <p class="text-yellow-500 text-xs font-bold uppercase">Dados</p>
                    <input type="text" id="perf-nome" class="input-dark">
                    <input type="text" id="perf-cpf" class="input-dark" readonly>
                    <input type="tel" id="perf-zap" class="input-dark">
                </div>
                <button onclick="savePerfil()" id="btn-save-perf" class="btn-primary">SALVAR</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="nav-radar" onclick="navegar('radar')"><i class="fas fa-home"></i>Início</div>
            <div class="nav-item" id="nav-perfil" onclick="navegar('perfil')"><i class="fas fa-user"></i>Conta</div>
        </div>

    </div>

    <div id="modal-pin" class="modal-overlay hidden-force">
        <div class="bg-gray-800 border border-gray-700 w-full max-w-xs p-6 rounded-2xl text-center relative shadow-2xl">
            <button onclick="closeModal('pin')" class="absolute top-4 right-4 text-gray-500"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold text-white mb-2">Alterar PIN</h3>
            <p class="text-xs text-gray-400 mb-4">Use 4 dígitos numéricos.</p>
            <input type="tel" id="input-pin" maxlength="4" class="bg-gray-900 border border-gray-600 text-white text-center text-3xl p-3 rounded-xl w-full mb-4 tracking-widest outline-none focus:border-yellow-500" placeholder="••••">
            <button onclick="salvarPin()" class="btn-primary">SALVAR</button>
        </div>
    </div>

    <div id="modal-pass" class="modal-overlay hidden-force">
        <div class="bg-gray-800 border border-gray-700 w-full max-w-xs p-6 rounded-2xl text-center relative shadow-2xl">
            <button onclick="closeModal('pass')" class="absolute top-4 right-4 text-gray-500"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold text-white mb-4">Nova Senha</h3>
            <input type="password" id="input-pass" class="input-dark mb-4" placeholder="Mínimo 6 caracteres">
            <button onclick="salvarSenha()" class="btn-primary">SALVAR</button>
        </div>
    </div>

    <div id="toast-box"></div>

    <script>
        // CONFIGURAÇÃO
        const SUPABASE_URL = 'https://ofpnnijkhgsjarixoyhg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mcG5uaWpraGdzamFyaXhveWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNjUyNzYsImV4cCI6MjA4MDY0MTI3Nn0.dNOIIETmTz3l1HvhuT-ihAiymJqiaYZnklzzBzDGCFU';
        
        let sbClient, userSession, isOnline = false;
        let saldoReal = 0, isSaldoVisible = false;

        // INICIALIZAÇÃO SEGURA
        (async function init() {
            try {
                sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Timeout de Segurança (2s)
                setTimeout(() => { if(document.getElementById('state-loading').style.display !== 'none') changeState('guest'); }, 2000);

                const { data } = await sbClient.auth.getSession();
                if (data.session) {
                    userSession = data.session;
                    await loadUser();
                } else {
                    changeState('guest');
                }
            } catch (e) {
                console.error(e);
                changeState('guest'); // Falha segura
            }
        })();

        // GERENCIADOR DE ESTADOS (CAMADAS)
        function changeState(state) {
            document.querySelectorAll('.app-state').forEach(el => el.classList.remove('active'));
            document.getElementById('state-' + state).classList.add('active');
            
            // Remove o splash se ainda estiver visível
            const splash = document.getElementById('state-loading');
            if (splash.classList.contains('active') && state !== 'loading') splash.classList.remove('active');
        }

        function toggleGuestScreen(screen) {
            document.getElementById('screen-login').classList.toggle('hidden-force', screen !== 'login');
            document.getElementById('screen-cadastro').classList.toggle('hidden-force', screen !== 'cadastro');
        }

        function navigate(screenId) {
            document.querySelectorAll('#member-zone > div[id^="view-"]').forEach(el => el.classList.add('hidden-force'));
            document.getElementById('view-' + screenId).classList.remove('hidden-force');
            document.getElementById('side-menu').classList.remove('open');
            document.getElementById('menu-overlay').classList.remove('open');
            
            // Atualiza barra inferior
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navBtn = document.getElementById('nav-' + screenId);
            if(navBtn) navBtn.classList.add('active');
        }

        // --- LÓGICA DE USUÁRIO ---
        async function loadUser() {
            const { data } = await sbClient.from('motoboys').select('*').eq('id', userSession.user.id).single();
            if (!data) { logout(); return; }

            if (data.status !== 'Aprovado') {
                changeState('pending');
                return;
            }

            // Preencher dados
            document.getElementById('menu-nome').innerText = data.nome;
            document.getElementById('menu-id').innerText = `ID: ${data.id.split('-')[0]}`;
            if(data.foto_url) document.getElementById('menu-user-foto').src = data.foto_url;
            
            saldoReal = data.saldo || 0;
            updateSaldoDisplay();

            // Preencher Perfil
            ['nome','cpf','whatsapp'].forEach(f => {
                if(document.getElementById('perf-'+(f==='whatsapp'?'zap':f))) 
                    document.getElementById('perf-'+(f==='whatsapp'?'zap':f)).value = data[f] || '';
            });

            changeState('app');
            // Iniciar Radar Realtime aqui se necessário
        }

        // --- AÇÕES ---
        async function fazerLogin() {
            const e = $('#log-email').val(), p = $('#log-senha').val();
            if(!e || !p) return toast("Preencha tudo", 'error');
            
            $('#btn-login').text('...');
            const { error } = await sbClient.auth.signInWithPassword({ email:e, password:p });
            if (error) { 
                toast("Erro ao entrar", 'error'); 
                $('#btn-login').text('ENTRAR'); 
            } else {
                location.reload();
            }
        }

        async function logout() {
            if(confirm("Sair do App?")) {
                await sbClient.auth.signOut();
                localStorage.clear();
                location.reload();
            }
        }

        function toggleOnline() {
            isOnline = !isOnline;
            const btn = document.getElementById('btn-go');
            const status = document.getElementById('radar-status');
            
            if(isOnline) {
                btn.classList.add('offline'); // Fica vermelho para parar
                btn.innerText = "PARAR";
                status.innerHTML = '<p class="text-green-400 font-bold animate-pulse">Procurando corridas...</p>';
                // Play sound logic here
            } else {
                btn.classList.remove('offline');
                btn.innerText = "INICIAR";
                status.innerHTML = '<i class="fas fa-power-off text-4xl text-gray-600 mb-2"></i><p class="text-lg font-bold text-gray-400">Você está Offline</p>';
            }
        }

        // --- SALDO E SEGURANÇA ---
        function toggleSaldo() {
            isSaldoVisible = !isSaldoVisible;
            updateSaldoDisplay();
        }

        function updateSaldoDisplay() {
            const el = document.getElementById('header-saldo');
            const icon = document.getElementById('eye-icon');
            if (isSaldoVisible) {
                el.innerText = `R$ ${saldoReal.toFixed(2)}`;
                icon.className = "fas fa-eye ml-1";
            } else {
                el.innerText = "R$ ****";
                icon.className = "fas fa-eye-slash ml-1";
            }
        }

        // --- MODAIS ---
        function openModal(id) { document.getElementById('modal-'+id).classList.remove('hidden-force'); }
        function closeModal(id) { document.getElementById('modal-'+id).classList.add('hidden-force'); }

        async function salvarPin() {
            const pin = $('#input-pin').val();
            if(pin.length !== 4) return toast("PIN deve ter 4 números", 'error');
            await sbClient.from('motoboys').update({pin_carteira: pin}).eq('id', userSession.user.id);
            toast("PIN Salvo!", 'success'); closeModal('pin');
        }

        // --- NAVEGAÇÃO INTERNA ---
        function navegar(to) {
            if (to === 'radar') {
                document.getElementById('view-perfil').classList.add('hidden-force');
                document.getElementById('view-radar').classList.remove('hidden-force');
            } else if (to === 'perfil') {
                document.getElementById('view-radar').classList.add('hidden-force');
                document.getElementById('view-perfil').classList.remove('hidden-force');
            }
            toggleMenu(false);
        }

        function toggleMenu(forceClose) {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('menu-overlay');
            if (forceClose === false || menu.classList.contains('open')) {
                menu.classList.remove('open'); overlay.classList.remove('open');
            } else {
                menu.classList.add('open'); overlay.classList.add('open');
            }
        }

        // --- UTILS ---
        function toast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = msg;
            document.getElementById('toast-box').appendChild(t);
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
        }

        // JQuery Masks
        $(document).ready(function(){
            $('#cad-cpf, #perf-cpf').mask('000.000.000-00');
            $('#cad-zap, #perf-zap').mask('(00) 00000-0000');
        });
    </script>
</body>
</html>
