<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Drop Entregas - Parceiro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GERAIS (TEMA DARK + AMARELO) --- */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #111827; /* Gray 900 */
            color: #e5e7eb; 
            padding-bottom: 90px; /* Espaço para menu inferior */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Animações */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-once { animation: pulseOnce 0.5s ease-in-out; }
        @keyframes pulseOnce { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Componentes UI */
        .btn-action { 
            background-color: #FBBF24; color: black; font-weight: bold; 
            transition: all 0.2s; border-radius: 12px; text-transform: uppercase;
        }
        .btn-action:hover { background-color: #F59E0B; transform: scale(1.02); }
        .btn-action:active { transform: scale(0.95); }
        .btn-action:disabled { background-color: #4B5563; color: #9CA3AF; cursor: not-allowed; transform: none; }

        .dark-card { background-color: #1F2937; border: 1px solid #374151; border-radius: 16px; overflow: hidden; }
        
        /* Inputs Formuário */
        .input-dark { 
            background-color: #111827; border: 1px solid #4b5563; color: white; 
            padding: 14px; border-radius: 10px; width: 100%; outline: none; transition: 0.3s; 
        }
        .input-dark:focus { border-color: #FBBF24; }
        .input-error { border-color: #EF4444 !important; }
        .msg-error { color: #EF4444; font-size: 11px; margin-top: 4px; display: none; }
        
        /* Botões de GPS/Zap */
        .btn-tool { 
            display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 10px; border-radius: 8px; font-size: 12px; font-weight: bold; transition: 0.2s;
        }
        .btn-tool:active { transform: scale(0.95); }

        /* Menu Inferior Glassmorphism */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(31, 41, 55, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #374151; 
            display: flex; justify-content: space-around; align-items: center;
            padding: 12px 0; z-index: 50; max-width: 28rem; margin: 0 auto;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; 
            color: #6B7280; cursor: pointer; flex: 1; transition: 0.2s; font-size: 10px;
        }
        .nav-item.active { color: #FBBF24; font-weight: bold; transform: translateY(-2px); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* Layout Desktop */
        .app-container { width: 100%; min-height: 100vh; }
        @media (min-width: 768px) { 
            .app-container { max-width: 28rem; margin: 0 auto; border-radius: 1.5rem; box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; height: 95vh; margin-top: 2vh; border: 1px solid #374151; }
            body { display: flex; justify-content: center; background-color: #000; overflow: hidden; }
            .bottom-nav { border-radius: 0 0 1.5rem 1.5rem; bottom: auto; top: auto; position: absolute; bottom: 0; }
        }

        /* Helpers */
        .section-title { font-size: 12px; color: #FBBF24; font-weight: bold; text-transform: uppercase; margin: 20px 0 8px 0; letter-spacing: 1px; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #FBBF24; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container relative overflow-y-auto custom-scroll">
        
        <div id="global-loading" class="absolute inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
            <div class="spinner w-10 h-10 border-4 mb-4"></div>
            <p class="text-gray-400 text-sm font-bold animate-pulse">Carregando Sistema...</p>
        </div>

        <div id="screen-welcome" class="hidden min-h-full flex flex-col justify-center p-8 text-center fade-in">
            <div class="mb-10">
                <div class="inline-flex p-5 rounded-full bg-yellow-500 text-black mb-4 shadow-[0_0_20px_rgba(245,158,11,0.3)]">
                    <i class="fas fa-motorcycle text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-1">Drop Entregas</h1>
                <p class="text-gray-400 text-sm">App do Parceiro</p>
            </div>
            
            <div class="space-y-4 w-full">
                <input type="email" id="log-email" class="input-dark text-center" placeholder="Seu E-mail">
                <input type="password" id="log-senha" class="input-dark text-center" placeholder="Sua Senha">
                <button onclick="fazerLogin()" id="btn-login" class="w-full btn-action py-4 text-lg shadow-lg">ENTRAR</button>
                <p onclick="showScreen('cadastro')" class="text-gray-500 text-xs mt-6 cursor-pointer underline hover:text-yellow-500 transition">Quero ser um parceiro</p>
            </div>
        </div>

        <div id="screen-pending" class="hidden min-h-full flex flex-col justify-center p-8 text-center fade-in bg-gray-900 z-50 absolute inset-0">
            <div class="mb-6 text-yellow-500 animate-pulse"><i class="fas fa-clock text-7xl"></i></div>
            <h2 class="text-2xl font-bold text-white mb-2">Cadastro em Análise</h2>
            <p class="text-gray-400 text-sm mb-8 leading-relaxed">Recebemos seus dados. Nossa equipe está validando sua documentação. Você receberá o acesso assim que for aprovado.</p>
            
            <div class="bg-gray-800 p-4 rounded-xl mb-8 border border-gray-700">
                <p class="text-xs text-gray-500 uppercase font-bold mb-1">STATUS ATUAL</p>
                <p class="text-yellow-400 font-bold text-lg tracking-widest">PENDENTE</p>
            </div>
            <button onclick="fazerLogout()" class="text-gray-500 underline text-sm hover:text-white">Sair da conta</button>
        </div>

        <div id="screen-cadastro" class="hidden p-6 pb-20 fade-in bg-gray-900 absolute inset-0 overflow-y-auto z-50">
            <div class="flex items-center mb-6 pt-2">
                <button onclick="showScreen('welcome')" class="text-gray-400 hover:text-white mr-4"><i class="fas fa-arrow-left text-xl"></i></button>
                <h2 class="text-xl font-bold text-white">Novo Parceiro</h2>
            </div>

            <p class="section-title">Dados Pessoais</p>
            <div class="space-y-4">
                <div><input type="text" id="cad-nome" class="input-dark" placeholder="Nome Completo*"><p id="msg-nome" class="msg-error">Obrigatório.</p></div>
                <div><input type="text" id="cad-cpf" class="input-dark" placeholder="CPF (000.000.000-00)*"><p id="msg-cpf" class="msg-error">Inválido.</p></div>
                <div><input type="text" id="cad-zap" class="input-dark" placeholder="WhatsApp (DDD+9...)*"><p id="msg-zap" class="msg-error">Inválido.</p></div>
            </div>

            <p class="section-title">Moto</p>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><input type="text" id="moto-placa" class="input-dark uppercase text-center font-bold" placeholder="PLACA*"><p id="msg-placa" class="msg-error">Inválida.</p></div>
                    <div><input type="text" id="moto-modelo" class="input-dark" placeholder="Modelo/Ano*"></div>
                </div>
                <div><input type="text" id="moto-cor" class="input-dark" placeholder="Cor da Moto*"></div>
            </div>

            <p class="section-title">Acesso</p>
            <div class="space-y-4">
                <div><input type="email" id="cad-email" class="input-dark" placeholder="E-mail de Login*"><p id="msg-email" class="msg-error">Inválido.</p></div>
                <div><input type="password" id="cad-senha" class="input-dark" placeholder="Senha (Min 6 dígitos)*"><p id="msg-senha" class="msg-error">Mínimo 6 caracteres.</p></div>
            </div>

            <button onclick="enviarCadastro()" id="btn-cadastrar" class="w-full btn-action py-4 rounded-xl shadow-lg mt-8 text-lg">ENVIAR SOLICITAÇÃO</button>
        </div>


        <div id="app-header" class="hidden p-5 flex justify-between items-center bg-gray-900 border-b border-gray-800 sticky top-0 z-40 shadow-md">
            <div>
                <h1 class="text-lg font-bold text-white">Drop <span class="text-yellow-500">Motoboy</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></span>
                    <p class="text-xs text-gray-400" id="status-text">Conectando...</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Saldo</p>
                    <p class="text-sm font-bold text-green-400" id="header-saldo">R$ 0,00</p>
                </div>
                <button onclick="fazerLogout()" class="bg-gray-800 p-2 w-8 h-8 rounded-full text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-red-400"><i class="fas fa-power-off text-xs"></i></button>
            </div>
        </div>

        <div id="screen-radar" class="hidden p-4 pb-24 fade-in">
            <div id="radar-empty" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-50">
                <div class="relative">
                    <div class="absolute inset-0 bg-yellow-500 blur-xl opacity-20 rounded-full animate-pulse"></div>
                    <i class="fas fa-satellite-dish text-6xl mb-4 text-gray-600 relative z-10"></i>
                </div>
                <p class="text-sm font-bold text-gray-400">Procurando pedidos...</p>
                <p class="text-xs text-gray-600 mt-2">Fique atento, novas corridas aparecerão aqui.</p>
            </div>
            
            <div id="radar-list" class="space-y-4"></div>
        </div>

        <div id="screen-active" class="hidden p-4 pb-24 fade-in">
            
            <div class="bg-green-500/10 border border-green-500/30 p-4 rounded-xl flex items-center justify-between mb-4 shadow-[0_0_15px_rgba(16,185,129,0.1)]">
                <div class="flex items-center gap-3">
                    <div class="bg-green-500 text-black w-10 h-10 rounded-full flex items-center justify-center font-bold animate-pulse text-lg"><i class="fas fa-motorcycle"></i></div>
                    <div>
                        <p class="text-sm font-bold text-green-400">EM ROTA</p>
                        <p class="text-xs text-green-300/70">Pedido #<span id="active-id">0000</span></p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-white">R$ <span id="active-valor">0,00</span></p>
            </div>

            <div class="dark-card p-5 relative mb-4">
                <div class="absolute left-6 top-8 bottom-12 w-0.5 bg-gray-700 z-0"></div>
                
                <div class="flex gap-4 mb-8 relative z-10">
                    <div class="w-4 h-4 rounded-full bg-blue-500 border-2 border-gray-800 shadow-[0_0_10px_#3B82F6] shrink-0 mt-1"></div>
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">COLETA (LOJA)</p>
                        <p class="text-base font-bold text-gray-200 leading-tight mb-2" id="active-origem">...</p>
                        <div class="flex gap-2">
                            <button onclick="abrirGps('origem')" class="btn-tool bg-gray-700 text-white hover:bg-gray-600"><i class="fas fa-location-arrow"></i> GPS</button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 relative z-10">
                    <div class="w-4 h-4 rounded-full bg-yellow-500 border-2 border-gray-800 shadow-[0_0_10px_#F59E0B] shrink-0 mt-1"></div>
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">ENTREGA (CLIENTE)</p>
                        <p class="text-base font-bold text-gray-200 leading-tight mb-1" id="active-destino">...</p>
                        <p class="text-xs text-gray-400 mb-3" id="active-cliente-nome">...</p>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="abrirGps('destino')" class="btn-tool bg-gray-700 text-white hover:bg-gray-600"><i class="fas fa-location-arrow"></i> GPS</button>
                            <button onclick="abrirZap()" class="btn-tool bg-green-600 text-white hover:bg-green-500"><i class="fab fa-whatsapp text-lg"></i> Contatar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dark-card p-4 flex justify-between items-center mb-6">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Cobrar do Cliente</p>
                    <p class="text-white font-bold text-lg" id="active-forma">...</p>
                </div>
                <div class="text-right">
                   <p class="text-[10px] text-yellow-500 uppercase font-bold border border-yellow-500/30 px-2 py-1 rounded">Verificar Valor com Loja</p>
                </div>
            </div>

            <button onclick="abrirModalPin()" class="w-full btn-action py-4 text-lg shadow-[0_0_20px_rgba(251,191,36,0.2)] mb-3">
                <i class="fas fa-check-circle mr-2"></i> FINALIZAR ENTREGA
            </button>
            <button onclick="cancelarCorrida()" class="w-full text-center text-xs text-red-500 py-2 opacity-60 hover:opacity-100">Cancelar Corrida (Emergência)</button>
        </div>

        <div id="screen-extract" class="hidden p-4 pb-24 fade-in">
            <h2 class="text-xl font-bold text-white mb-4">Histórico</h2>
            <div id="history-list" class="space-y-3"></div>
        </div>

        <div id="modal-pin" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-6 fade-in">
            <div class="bg-gray-800 w-full max-w-xs p-6 rounded-2xl border border-gray-700 text-center relative">
                <button onclick="fecharModalPin()" class="absolute top-3 right-3 text-gray-500 p-2"><i class="fas fa-times"></i></button>
                <div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-500 flex items-center justify-center mx-auto mb-3"><i class="fas fa-lock text-xl"></i></div>
                <h3 class="text-lg font-bold text-white mb-1">Validar Entrega</h3>
                <p class="text-xs text-gray-400 mb-6">Peça o PIN de 4 dígitos ao cliente</p>
                
                <input type="tel" id="input-pin" maxlength="4" class="w-full bg-gray-900 border border-gray-600 rounded-xl p-4 text-center text-3xl font-bold tracking-[0.5em] text-white mb-6 focus:border-yellow-500 outline-none placeholder-gray-700" placeholder="0000">
                
                <button onclick="validarPin()" class="w-full btn-action py-3 rounded-xl">CONFIRMAR</button>
            </div>
        </div>

        <div id="bottom-menu" class="hidden bottom-nav">
            <div class="nav-item active" id="nav-radar" onclick="navegar('radar')">
                <i class="fas fa-map-marked-alt"></i><span>Radar</span>
            </div>
            <div class="nav-item" id="nav-active" onclick="navegar('active')">
                <i class="fas fa-box"></i><span>Corrida</span>
            </div>
            <div class="nav-item" id="nav-extract" onclick="carregarExtrato(); navegar('extract')">
                <i class="fas fa-wallet"></i><span>Ganhos</span>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://ofpnnijkhgsjarixoyhg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJvZnBubmlqa2hnc2phcml4b3loZyIsImJvbGUiOiJhbm9uIiwiaWF0IjoxNzY1MDY1Mjc2LCJleHAiOjIwODA2NDEyNzZ9.dNOIIETmTz3l1HvhuT-ihAiymJqiaYZnklzzBzDGCFU';
        
        let sbClient = null;
        let userSession = null;
        let pedidoAtual = null;

        // MÁSCARAS
        $(document).ready(function(){ 
            $('#cad-cpf').mask('000.000.000-00');
            $('#cad-zap').mask('(00) 00000-0000');
            $('#moto-placa').on('input', function() { this.value = this.value.toUpperCase(); });
        });

        // --- INICIALIZAÇÃO ---
        window.onload = async function() {
            try {
                sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data: { session } } = await sbClient.auth.getSession();

                if (session) { 
                    userSession = session; 
                    verificarEstadoUsuario(); 
                } else { 
                    showScreen('welcome');
                    document.getElementById('global-loading').style.display = 'none';
                }
            } catch(e) {
                alert("Erro de conexão.");
                console.error(e);
            }
        };

        // --- SISTEMA DE NAVEGAÇÃO ---
        function showScreen(id) {
            // Esconde todas
            ['welcome', 'cadastro', 'pending', 'radar', 'active', 'extract'].forEach(s => document.getElementById('screen-'+s).classList.add('hidden'));
            document.getElementById('screen-'+id).classList.remove('hidden');

            // Lógica Menu Inferior e Header
            const isApp = ['radar', 'active', 'extract'].includes(id);
            const menu = document.getElementById('bottom-menu');
            const header = document.getElementById('app-header');

            if (isApp) {
                menu.classList.remove('hidden'); menu.classList.add('flex');
                header.classList.remove('hidden'); header.classList.add('flex');
            } else {
                menu.classList.add('hidden'); menu.classList.remove('flex');
                header.classList.add('hidden'); header.classList.remove('flex');
            }

            // Global Loading Off
            document.getElementById('global-loading').style.display = 'none';
        }

        function navegar(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-'+tab).classList.add('active');
            
            // Se tentar ir pro radar mas tem corrida ativa, força active
            if(tab === 'radar' && pedidoAtual) { navegar('active'); return; }
            
            showScreen(tab);
        }

        // --- LÓGICA DE USUÁRIO (LOGIN/APROVAÇÃO) ---
        async function verificarEstadoUsuario() {
            try {
                // 1. Busca perfil
                const { data: perfil, error } = await sbClient.from('motoboys').select('*').eq('id', userSession.user.id).single();
                
                if (error || !perfil) {
                    // Usuário deletado ou erro
                    sbClient.auth.signOut(); 
                    location.reload(); 
                    return;
                }

                // 2. Atualiza Saldo no Header
                document.getElementById('header-saldo').innerText = `R$ ${(perfil.saldo || 0).toFixed(2)}`;

                // 3. Verifica Status Aprovação
                if (perfil.status !== 'Aprovado') {
                    showScreen('pending');
                } else {
                    // APROVADO: Inicia App
                    iniciarOperacao();
                }
            } catch(e) { console.error(e); showScreen('welcome'); }
        }

        async function fazerLogin() {
            const email = document.getElementById('log-email').value;
            const senha = document.getElementById('log-senha').value;
            const btn = document.getElementById('btn-login');

            if(!email || !senha) return alert("Preencha tudo.");
            btn.innerText = "..."; btn.disabled = true;

            const { data, error } = await sbClient.auth.signInWithPassword({ email, password: senha });

            if (error) {
                alert("Erro: " + error.message);
                btn.innerText = "ENTRAR"; btn.disabled = false;
            } else {
                location.reload();
            }
        }

        function fazerLogout() { sbClient.auth.signOut(); location.reload(); }

        async function enviarCadastro() {
            // Coleta básica (expandir conforme necessidade)
            const nome = document.getElementById('cad-nome').value;
            const cpf = document.getElementById('cad-cpf').value;
            const zap = document.getElementById('cad-zap').value;
            const placa = document.getElementById('moto-placa').value;
            const modelo = document.getElementById('moto-modelo').value;
            const email = document.getElementById('cad-email').value;
            const senha = document.getElementById('cad-senha').value;

            if(!nome || !cpf || !zap || !placa || !email || !senha) return alert("Preencha todos os campos obrigatórios.");
            if(senha.length < 6) return alert("Senha muito curta.");

            const btn = document.getElementById('btn-cadastrar');
            btn.innerText = "Enviando..."; btn.disabled = true;

            const metaData = { tipo_usuario: 'motoboy', nome, cpf, whatsapp: zap, placa, modelo, status: 'Pendente' };

            const { error } = await sbClient.auth.signUp({
                email, password: senha, options: { data: metaData }
            });

            if(error) {
                alert("Erro: " + error.message);
                btn.innerText = "ENVIAR SOLICITAÇÃO"; btn.disabled = false;
            } else {
                alert("Cadastro enviado! Faça login.");
                location.reload();
            }
        }
                // --- OPERAÇÃO (CORE) ---
        function iniciarOperacao() {
            // Status Online
            document.getElementById('status-dot').classList.remove('bg-gray-500');
            document.getElementById('status-dot').classList.add('bg-green-500', 'animate-pulse');
            document.getElementById('status-text').innerText = "Online";

            verificarPedidoAtivo(); // Checa se já está em corrida
            carregarRadar(); // Carrega lista
            inscreverRealtime(); // Escuta novos pedidos
        }

        // --- RADAR ---
        async function carregarRadar() {
            const { data } = await sbClient.from('pedidos')
                .select('*')
                .eq('status', 'Solicitado')
                .order('created_at', { ascending: false });

            const list = document.getElementById('radar-list');
            list.innerHTML = '';

            if (data && data.length > 0) {
                document.getElementById('radar-empty').classList.add('hidden');
                data.forEach(p => adicionarCardRadar(p));
            } else {
                document.getElementById('radar-empty').classList.remove('hidden');
            }
        }

        function adicionarCardRadar(p) {
            const list = document.getElementById('radar-list');
            const card = document.createElement('div');
            card.id = `card-${p.id}`;
            card.className = "dark-card p-4 border-l-4 border-yellow-500 pulse-once relative";
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded text-gray-300"><i class="fas fa-store mr-1"></i> Retirada</span>
                    <span class="text-green-400 font-bold text-lg">R$ ${parseFloat(p.valor_frete).toFixed(2)}</span>
                </div>
                <h3 class="font-bold text-white text-sm mb-1 line-clamp-1">${p.origem}</h3>
                
                <div class="my-2 border-l border-gray-600 pl-3 ml-1">
                    <p class="text-xs text-gray-500">Entrega para Cliente</p>
                    <p class="text-gray-300 text-sm line-clamp-1">${p.destino}</p>
                </div>

                <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                    <span class="text-xs text-yellow-500 font-bold">${p.forma_pagamento || 'Dinheiro'}</span>
                    <button onclick="aceitarCorrida(${p.id})" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-6 rounded-lg text-sm shadow-lg transition">ACEITAR</button>
                </div>
            `;
            list.prepend(card);
            document.getElementById('radar-empty').classList.add('hidden');
        }

        function inscreverRealtime() {
            sbClient.channel('tabela-pedidos')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, payload => {
                if(payload.new.status === 'Solicitado') adicionarCardRadar(payload.new);
            })
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'pedidos' }, payload => {
                // Se o pedido sair de Solicitado (alguém pegou), remove do radar
                if(payload.new.status !== 'Solicitado') {
                    const el = document.getElementById(`card-${payload.new.id}`);
                    if(el) el.remove();
                    // Se ficou vazio
                    if(document.getElementById('radar-list').children.length === 0) 
                        document.getElementById('radar-empty').classList.remove('hidden');
                }
            })
            .subscribe();
        }

        // --- AÇÕES DE CORRIDA ---
        async function aceitarCorrida(id) {
            if(!confirm("Aceitar corrida?")) return;

            // Tenta pegar a corrida (Atomicidade garantida pelo RLS ou verificação simples aqui)
            // Atualiza status para 'Em Rota' e define motoboy_id
            const { error } = await sbClient.from('pedidos')
                .update({ status: 'Em Rota', motoboy_id: userSession.user.id })
                .eq('id', id)
                .eq('status', 'Solicitado'); // Garante que ainda está disponível

            if (error) {
                alert("Ops! Outro entregador foi mais rápido.");
                carregarRadar();
            } else {
                verificarPedidoAtivo();
            }
        }

        async function verificarPedidoAtivo() {
            // Busca pedido 'Em Rota' deste motoboy
            const { data, error } = await sbClient.from('pedidos')
                .select('*')
                .eq('motoboy_id', userSession.user.id)
                .eq('status', 'Em Rota')
                .single();

            if (data) {
                pedidoAtual = data;
                renderizarPedidoAtivo(data);
                navegar('active'); // Força tela ativa
            } else {
                pedidoAtual = null;
                // Se estava na tela active, volta pro radar
                if(document.getElementById('nav-active').classList.contains('active')) {
                    navegar('radar');
                }
            }
        }

        function renderizarPedidoAtivo(p) {
            document.getElementById('active-id').innerText = p.id;
            document.getElementById('active-valor').innerText = p.valor_frete.toFixed(2);
            document.getElementById('active-origem').innerText = p.origem;
            document.getElementById('active-destino').innerText = p.destino;
            document.getElementById('active-cliente-nome').innerText = p.nome_destinatario || "Cliente";
            document.getElementById('active-forma').innerText = p.forma_pagamento || "Dinheiro";
        }
               // --- FINALIZAÇÃO (PIN) ---
        function abrirModalPin() { document.getElementById('modal-pin').classList.remove('hidden'); document.getElementById('input-pin').value=''; document.getElementById('input-pin').focus(); }
        function fecharModalPin() { document.getElementById('modal-pin').classList.add('hidden'); }

        async function validarPin() {
            const pin = document.getElementById('input-pin').value;
            if(pin.length !== 4) return alert("Digite 4 números.");

            // Verifica PIN no banco (Mais seguro que verificar localmente se possível, ou usa o local se confiável)
            // Aqui usamos lógica local baseada no objeto carregado, mas validamos a update no banco
            if (pin !== pedidoAtual.pin_entrega) {
                alert("PIN Incorreto!");
                return;
            }

            // Atualiza Pedido
            const { error } = await sbClient.from('pedidos')
                .update({ status: 'Finalizado' })
                .eq('id', pedidoAtual.id);

            if(error) return alert("Erro ao finalizar.");

            // Atualiza Saldo Motoboy (Trigger ou Manual)
            // Manual aqui para simplicidade de feedback visual
            const saldoAtual = parseFloat(document.getElementById('header-saldo').innerText.replace('R$ ','').replace(',','.'));
            const novoSaldo = saldoAtual + pedidoAtual.valor_frete;
            
            await sbClient.from('motoboys').update({ saldo: novoSaldo }).eq('id', userSession.user.id);
            document.getElementById('header-saldo').innerText = `R$ ${novoSaldo.toFixed(2)}`;

            alert("Corrida Finalizada com Sucesso!");
            fecharModalPin();
            verificarPedidoAtivo(); // Vai limpar e voltar pro Radar
        }

        async function cancelarCorrida() {
            if(!confirm("Cancelar corrida? Isso afetará sua reputação.")) return;
            
            await sbClient.from('pedidos')
                .update({ status: 'Solicitado', motoboy_id: null })
                .eq('id', pedidoAtual.id);
                
            verificarPedidoAtivo();
        }

        // --- UTILITÁRIOS ---
        function abrirGps(tipo) {
            const end = tipo === 'origem' ? pedidoAtual.origem : pedidoAtual.destino;
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(end)}`, '_blank');
        }
        function abrirZap() {
            if(!pedidoAtual.telefone_destinatario) return alert("Sem telefone.");
            let tel = pedidoAtual.telefone_destinatario.replace(/\D/g,'');
            if(!tel.startsWith('55')) tel = '55'+tel;
            window.open(`https://wa.me/${tel}`, '_blank');
        }

        async function carregarExtrato() {
            const div = document.getElementById('history-list');
            div.innerHTML = '<div class="spinner mx-auto"></div>';
            
            const { data } = await sbClient.from('pedidos')
                .select('*')
                .eq('motoboy_id', userSession.user.id)
                .eq('status', 'Finalizado')
                .order('created_at', {ascending:false})
                .limit(10);
            
            div.innerHTML = '';
            if(!data.length) div.innerHTML = '<p class="text-gray-500 text-sm text-center">Nenhuma corrida recente.</p>';
            
            data.forEach(p => {
                div.innerHTML += `
                    <div class="dark-card p-3 flex justify-between items-center">
                        <div>
                            <p class="text-sm text-white font-bold">${p.destino}</p>
                            <p class="text-xs text-gray-500">${new Date(p.created_at).toLocaleDateString()}</p>
                        </div>
                        <span class="text-green-400 font-bold">+ R$ ${p.valor_frete.toFixed(2)}</span>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
